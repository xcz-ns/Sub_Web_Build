name: æ„å»º sub-web é•œåƒ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 3,6'
  push:
    paths:
      - 'src/views/Subconverter.vue'

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
  TG_BOT_TOKEN: "${{ secrets.TG_BOT_TOKEN }}"
  TG_CHAT_ID: "${{ secrets.TG_CHAT_ID }}"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v2

    - name: å®‰è£… jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: æ„å»º Docker é•œåƒ
      id: build-image
      run: |
        TODAY_TAG=$(date +'%m%d')
        IMAGE_NAME=subweb:$TODAY_TAG
        docker build --platform linux/amd64 -t $IMAGE_NAME .
        docker images

    - name: ä¿å­˜ Docker é•œåƒä¸º tar åŒ…
      run: |
        TODAY_TAG=$(date +'%m%d')
        docker save subweb:$TODAY_TAG -o subweb_$TODAY_TAG.tar
        ls -lh subweb_$TODAY_TAG.tar

    - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      run: |
        echo "${{ env.ALIYUN_REGISTRY_PASSWORD }}" | docker login $ALIYUN_REGISTRY -u $ALIYUN_REGISTRY_USER --password-stdin

    - name: æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘
      id: push-image
      run: |
        set -e
        TODAY_TAG=$(date +'%m%d')
        IMAGE_NAME=subweb:$TODAY_TAG
        ALIYUN_IMAGE=$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/subweb:$TODAY_TAG
        docker tag $IMAGE_NAME $ALIYUN_IMAGE
        if docker push $ALIYUN_IMAGE; then
          echo "PUSH_RESULT=success" >> $GITHUB_ENV
        else
          echo "PUSH_RESULT=failure" >> $GITHUB_ENV
        fi
        docker rmi $ALIYUN_IMAGE || true

        # è‡ªåŠ¨æ¸…ç†é˜¿é‡Œäº‘æ—§é•œåƒï¼Œåªä¿ç•™æœ€è¿‘10ä¸ª
        REPO=$ALIYUN_NAME_SPACE/subweb
        TAGS=$(curl -s -u "$ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD" \
          "https://$ALIYUN_REGISTRY/v2/$REPO/tags/list" | jq -r '.tags | sort | reverse')
        COUNT=0
        for TAG in $TAGS; do
          COUNT=$((COUNT+1))
          if [ $COUNT -gt 10 ]; then
            echo "åˆ é™¤æ—§é•œåƒ: $ALIYUN_REGISTRY/$REPO:$TAG"
            curl -s -X DELETE -u "$ALIYUN_REGISTRY_USER:$ALIYUN_REGISTRY_PASSWORD" \
              "https://$ALIYUN_REGISTRY/v2/$REPO/manifests/$TAG" || true
          fi
        done

    - name: å‘é€ Telegram é€šçŸ¥
      if: always()
      run: |
        TODAY_TAG=$(date +'%m%d')
        DISPLAY_NAME="sub-web:$TODAY_TAG"
        FULL_IMAGE_PATH="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAME_SPACE }}/subweb:$TODAY_TAG"
        BUILD_TIME=$(TZ='Asia/Shanghai' date "+%Y-%m-%d %H:%M:%S")

        MSG="ğŸ“¦ *é•œåƒæ„å»ºé€šçŸ¥*\n\n"
        MSG+="*é•œåƒåç§°*: \`$DISPLAY_NAME\`\n"
        MSG+="*æ„å»ºæ—¶é—´*: \`$BUILD_TIME\`\n"

        if [ "${{ env.PUSH_RESULT }}" == "success" ]; then
          STATUS="é˜¿é‡Œäº‘ âœ…"
          MSG+="*æ¨é€çŠ¶æ€*: $STATUS\n"
          MSG+="*è®¢é˜…åœ°å€*: \`$FULL_IMAGE_PATH\`"
        else
          STATUS="é˜¿é‡Œäº‘ âŒ"
          MSG+="*æ¨é€çŠ¶æ€*: $STATUS"
        fi

        curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ env.TG_CHAT_ID }}" \
          -d parse_mode="Markdown" \
          --data-urlencode "text=$(printf '%b' "${MSG}")"

    - name: åˆ é™¤æ—§çš„ Workflow è¿è¡Œè®°å½•
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.REPO_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 0

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: shidahuilang/delete-older-releases@main
      with:
        keep_latest: 1
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
