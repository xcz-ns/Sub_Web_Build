name: Build and Save Multi-Arch Docker Image

on:
  push:
    workflow_dispatch:

jobs:
  build-and-save:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      id: build-image
      run: |
        docker buildx build --platform linux/amd64,linux/arm64 -t careywong/subweb:latest .
    
    - name: Save Docker image as tarball
      run: |
        docker save careywong/subweb:latest -o subweb_latest.tar

    - name: Upload Docker image to GitHub Releases
      uses: ncipollo/release-action@v1
      with:
        artifacts: subweb_latest.tar
        tag: ${{ github.sha }}
        name: subweb_latest.tar
        overwrite: true
