name: æ„å»º sub-web é•œåƒ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4,10,16,22 * * *' # åŒ—äº¬æ—¶é—´ 12:00ã€18:00ã€00:00ã€06:00

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
  TG_BOT_TOKEN: "${{ secrets.TG_BOT_TOKEN }}"
  TG_CHAT_ID: "${{ secrets.TG_CHAT_ID }}"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v2

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: æ„å»º Docker é•œåƒ
      id: build-image
      run: |
        docker build --platform linux/amd64 -t subweb:latest .
        docker images

    - name: ä¿å­˜ Docker é•œåƒä¸º tar åŒ…
      run: |
        docker save subweb:latest -o subweb_latest.tar
        ls -lh subweb_latest.tar

    - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      run: |
        echo "${{ env.ALIYUN_REGISTRY_PASSWORD }}" | docker login $ALIYUN_REGISTRY -u $ALIYUN_REGISTRY_USER --password-stdin

    - name: æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘
      id: push-image
      run: |
        set -e
        IMAGE_NAME=subweb:latest
        ALIYUN_IMAGE=$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$IMAGE_NAME
        docker tag $IMAGE_NAME $ALIYUN_IMAGE
        if docker push $ALIYUN_IMAGE; then
          echo "PUSH_RESULT=success" >> $GITHUB_ENV
        else
          echo "PUSH_RESULT=failure" >> $GITHUB_ENV
        fi
        docker rmi $IMAGE_NAME $ALIYUN_IMAGE || true

    - name: å‘é€ Telegram é€šçŸ¥
      if: always()
      run: |
        DISPLAY_NAME="sub-web é•œåƒæ„å»º"
        BUILD_TIME=$(TZ='Asia/Shanghai' date "+%Y-%m-%d %H:%M:%S")
        STATUS="sub-web é•œåƒæ„å»ºå¤±è´¥"
        [[ "${{ env.PUSH_RESULT }}" == "success" ]] && STATUS="sub-web é•œåƒæ„å»ºæˆåŠŸ"

        MSG="ğŸ“¦ é•œåƒåç§°ï¼š$DISPLAY_NAME\nğŸ“… æ„å»ºæ—¶é—´ï¼š$BUILD_TIME\nâœ… çŠ¶æ€ï¼š$STATUS"

        printf "%b" "$MSG" | curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
          -d chat_id="$TG_CHAT_ID" \
          -d parse_mode="Markdown" \
          --data-urlencode "text=$(printf "%b" "$MSG")"
